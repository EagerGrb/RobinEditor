# 需求 4：历史记录（撤销 / 重做，命令模式）—— 任务分发

目标：为编辑器提供可扩展的历史记录系统，支持撤销（Undo）与重做（Redo），基于命令模式实现，可覆盖图元创建、删除、变换、属性修改等操作。

## PA 系（product-architect）

### TASK-4-PA-01 可撤销操作范围定义
- 职责：
  - 明确纳入历史记录的操作：
    - 墙体/门窗/家具等图元的创建与删除。
    - 选中集的平移/缩放/旋转变换。
    - 图元属性修改（尺寸、类型、标签等）。
  - 明确暂不纳入历史的操作（可选）：
    - 视图变换（平移/缩放）作为纯视图操作是否记录。
    - 选中状态改变是否纳入历史（建议不纳入）。
- 输出：
  - 在需求文档中增加「可撤销操作范围」说明。

### TASK-4-PA-02 历史记录行为规范
- 职责：
  - 定义撤销/重做交互：
    - 菜单命令：编辑 → 撤销 / 重做。
    - 快捷键：Ctrl+Z、Ctrl+Shift+Z（或 Cmd 组合）。
  - 定义历史栈容量策略（例如最近 100 步，可配置）。
- 输出：
  - 行为规范更新，供 FE/GE/QA 对齐。

## GE 系（graphics-engineer）—— 核心实现者

### TASK-4-GE-01 ICommand 抽象与 CommandManager
- 职责：
  - 定义 `ICommand` 接口：
    - `execute(): void`
    - `undo(): void`
  - 实现 CommandManager：
    - 维护 undo 栈与 redo 栈。
    - 提供方法：`executeCommand(cmd: ICommand)`, `undo()`, `redo()`。
    - 控制容量，超过上限时丢弃最旧记录。

### TASK-4-GE-02 基础命令类型实现
- 职责：
  - 至少实现以下命令类型：
    - CreateShapeCommand（创建墙体/门窗/家具等）。
    - DeleteShapeCommand（删除选中图元）。
    - TransformShapesCommand（平移/旋转/缩放选中集）。
    - ChangePropertiesCommand（图元属性修改，如厚度/高度/标签）。
  - 每个命令需要记录足够信息以支持准确 undo：
    - 原始状态快照或差分信息。

### TASK-4-GE-03 工具与命令系统的集成
- 职责：
  - 在工具完成一次「最终确定」的操作时：
    - 例如结束墙体绘制、完成一次变换、应用属性修改。
    - 构造对应 ICommand 实例并交给 CommandManager 执行。
  - 确保：
    - 内核不在多个地方重复修改状态，统一通过命令执行修改（或至少对可撤销操作遵循此原则）。

### TASK-4-GE-04 撤销 / 重做入口接口
- 职责：
  - 为外部暴露统一接口：
    - `undo()`: 调用 CommandManager.undo。
    - `redo()`: 调用 CommandManager.redo。
  - 接收来自 FE（菜单/快捷键）的调用请求。

## FE 系（frontend-architect）

### TASK-4-FE-01 菜单与快捷键映射
- 职责：
  - 在顶部菜单中实现 编辑 → 撤销 / 重做 按钮：
    - 点击时通过 event-bus 发布 `COMMAND.UNDO` / `COMMAND.REDO` 事件。
  - 在快捷键系统中：
    - 绑定 Ctrl+Z → `COMMAND.UNDO`。
    - 绑定 Ctrl+Shift+Z 或 Ctrl+Y → `COMMAND.REDO`。

### TASK-4-FE-02 中介者到内核的调用
- 职责：
  - 在 GraphicsMediator 中订阅 `COMMAND.UNDO` / `COMMAND.REDO`：
    - 调用内核的 `undo()` / `redo()`。

## QA 系（qa-automation-expert）

### TASK-4-QA-01 命令对象单元测试
- 职责：
  - 对每种命令类型（Create/Delete/Transform/ChangeProperties）：
    - 执行 execute 后验证场景状态符合预期。
    - 执行 undo 后验证状态回到初始值。
  - 对 TransformShapesCommand：
    - 注意旋转/缩放的数值误差，需要定义容差范围。

### TASK-4-QA-02 CommandManager 行为测试
- 职责：
  - 测试历史栈容量限制：
    - 连续执行超过容量的命令，检查最旧命令被丢弃而不会影响最近命令的撤销。 
  - 测试新命令插入行为：
    - 执行若干命令 → 撤销几步 → 再执行新命令 → redo 栈应被清空。

### TASK-4-QA-03 端到端撤销 / 重做测试
- 职责：
  - 使用 E2E 工具模拟用户：
    - 绘制墙体 → 撤销 → 检查墙体消失；再重做 → 墙体恢复。
    - 移动/旋转图元 → 撤销 → 检查位置与角度恢复。
    - 修改属性（例如墙厚）→ 撤销/重做 → 检查属性值变化。

