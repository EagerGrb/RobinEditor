# 需求 8：右键菜单（UI 命令模式 + 数据驱动 + 工具解析）—— 任务分发

目标：

- 在 UI 中实现数据驱动的右键菜单组件，采用命令模式；
- 右键菜单项选中后通过命令发送到内核，由代理中介者分发到对应场景或当前工具；
- Tool 抽象类需要提供 parse 方法，用于根据当前上下文生成右键菜单数据。

## PA 系（product-architect）

### TASK-8-PA-01 右键菜单交互规范
- 职责：
  - 定义右键菜单触发规则：
    - 右键点击空白区域 vs 右键点击选中图元上的差异。
    - 在画布区域与其他 UI 区域（面板、列表）中的行为区别。
  - 定义菜单关闭规则：
    - 点击菜单外区域、按 Esc、执行某些操作后自动关闭。
  - 定义不同上下文下的菜单内容层级（全局/场景/工具/图元级）。
- 输出：
  - 右键菜单交互规范文档，供 FE/GE 参考。

### TASK-8-PA-02 菜单项语义与命令分类
- 职责：
  - 按语义对菜单命令分类：
    - 图元操作类：删除、复制、对齐、锁定等。
    - 视图操作类：缩放到选中、隐藏/显示网格等。
    - 工具相关操作：结束当前绘制、切换模式等。
  - 约定命令命名规范：
    - 如：`CMD.DELETE_SELECTION`, `CMD.FIT_TO_SELECTION`, `CMD.TOOL_FINISH` 等。
- 输出：
  - 命令清单，为 UI 命令模式和内核解析提供统一基准。

## FE 系（frontend-architect）

### TASK-8-FE-01 右键菜单组件（数据驱动）
- 职责：
  - 实现一个通用右键菜单 React 组件：
    - 接收菜单数据结构数组（如：`{ id, label, icon, command, disabled }`）。
    - 支持分组、分隔线、子菜单（可后续扩展）。
  - 菜单展示由数据驱动，不在组件内部硬编码命令逻辑。

### TASK-8-FE-02 右键事件采集与上下文构建
- 职责：
  - 在 Canvas 容器中监听 `contextmenu` 事件：
    - 阻止浏览器默认右键菜单。
    - 获取点击位置的屏幕坐标与世界坐标。
    - 查询当前选中状态和命中的图元信息（通过内核/中介者提供的查询接口）。
  - 构造上下文对象：
    - 包含：位置、选中图元列表、当前工具类型、场景状态等。
  - 调用中介者/内核的接口获取菜单数据（见 GE 部分）。

### TASK-8-FE-03 命令模式实现与事件分发
- 职责：
  - 为右键菜单组件引入命令模式：
    - 菜单项只持有 command 标识和参数，不直接执行业务逻辑。
    - 用户点击菜单项时：
      - 将 command 信息封装为事件发送到 event-bus，例如：`CONTEXT_MENU.COMMAND_INVOKED`。
  - GraphicsMediator 订阅该事件并进一步转发给内核。

## GE 系（graphics-engineer）

### TASK-8-GE-01 Tool 抽象类 parse 方法设计
- 职责：
  - 在 Tool 抽象类中增加：
    - `parseContextMenu(context: ToolContext): ContextMenuItem[]`。
  - ToolContext 包含：
    - 右键位置（世界坐标）、当前选中集、当前场景状态等。
  - 默认实现可返回空列表；具体工具可覆盖以提供工具特定菜单项。

### TASK-8-GE-02 场景级/图元级菜单生成
- 职责：
  - 在内核中：
    - 根据右键点击位置和选中状态，确定调用哪个 Tool 或场景级逻辑生成菜单：
      - 若点击在选中图元上，优先调用当前 Tool 的 parseContextMenu。
      - 若点击在空白区域，可调用场景级 parse 方法。
  - 将内核生成的菜单项列表返回给中介者，再传递给 FE 显示。

### TASK-8-GE-03 菜单命令路由与执行
- 职责：
  - 接收来自 FE 的命令事件（经 GraphicsMediator）：
    - 命令格式包含 commandId、参数、上下文信息等。
  - 根据命令类型：
    - 工具相关命令：转发给当前 Tool 的执行方法（例如 `executeCommand(commandId, args)`）。
    - 场景相关命令：由内核统一处理（如删除选中、复制粘贴）。
  - 与命令模式（需求 4）集成：
    - 对需要撤销/重做的右键操作，内部仍构造成 ICommand 进行处理。

## RE 系（rendering-core-expert）

### TASK-8-RE-01 选中命中支持（供右键菜单上下文使用）
- 职责：
  - 确保在右键点击位置附近的命中测试可用：
    - 可由内核提供命中结果，但渲染层如有辅助信息（例如拾取缓冲）可后续考虑对接。
  - 本阶段可仅依赖内核命中测试，不强制渲染层变更。

## QA 系（qa-automation-expert）

### TASK-8-QA-01 菜单数据生成与 UI 展现测试
- 职责：
  - 针对 Tool.parseContextMenu：
    - 在无 UI 环境下测试不同上下文输入生成的菜单数据是否符合预期。
  - 在 E2E 中：
    - 在选中图元与空白处右键，检查菜单内容差异是否符合规范。

### TASK-8-QA-02 菜单命令执行链路测试
- 职责：
  - 端到端验证：
    - 右键点击 → 显示菜单 → 点击菜单项 → event-bus 发出命令 → GraphicsMediator 转发 → 内核执行。
  - 针对常见菜单命令（如删除选中、结束绘制）：
    - 验证图元状态与场景状态是否如预期变化。
    - 若命令应支持撤销，验证与命令系统协同是否正常。

