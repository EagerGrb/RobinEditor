# 需求 7：画布编码解码（流式解析 + 图元编解码）—— 任务分发

目标：

- 为当前场景提供「编码/解码」能力，支持将图元序列化为字符串并恢复；
- 采用流式解析方式，能够逐行解析，便于处理大场景；
- 设计一套行级文本存储格式，每行表示一个图元或控制指令。

## PA 系（product-architect）

### TASK-7-PA-01 编解码使用场景与约束定义
- 职责：
  - 定义编码/解码的主要用途：
    - 本地保存/加载。
    - 剪贴板拷贝（可选）。
    - 版本管理与差异比较（后续阶段）。
  - 明确约束：
    - 文本格式应具备可读性与可 diff 性。
    - 格式需拓展性良好，为未来字段与图元类型增加预留空间。
- 输出：
  - 文档说明「为何采用行文本格式」及适用边界。

### TASK-7-PA-02 存储格式高层设计
- 职责：
  - 确定基础格式方案：
    - 每行一个记录，包含：记录类型、版本号、图元类型、字段列表等。
    - 示例（伪）：`WALL|v1|id=...;x1=...;y1=...;x2=...;y2=...;thickness=...`。
  - 定义必要的记录类型：
    - 图元记录（WALL/OPENING/DIMENSION/ROOM/OBJECT 等）。
    - 场景元数据记录（META）。
  - 确保编码格式与现有 Scene JSON 模型在语义上保持一致。
- 输出：
  - 编码格式总体说明（字段含义、分隔符约定、版本策略）。

## GE 系（graphics-engineer）

### TASK-7-GE-01 图元编码规范设计
- 职责：
  - 基于 Scene 模型，为每类图元定义编码规则：
    - 必填字段与可选字段列表。
    - 数值精度与单位（例如：米/毫米、保留小数位数）。
    - 特殊字符转义规则（如文本标注内容）。
  - 为每类图元提供：
    - `encodeShape(shape: ShapeModel): string`。
    - `decodeShape(line: string): ShapeModel | Error`。
- 输出：
  - 编码/解码函数原型与字段映射表。

### TASK-7-GE-02 流式编码实现
- 职责：
  - 提供将整个场景编码为多行字符串的接口：
    - `encodeScene(scene: Scene): AsyncIterable<string> | string[]`。
  - 支持：
    - 按照图元类别或层级分组输出（例如先 META，再房间、墙体、门窗等）。
    - 便于调用方逐行写入文件或网络流。

### TASK-7-GE-03 流式解码实现
- 职责：
  - 提供从行流中解析场景的接口：
    - `decodeScene(lines: AsyncIterable<string> | string[]): Scene`。
  - 要求：
    - 支持逐行处理，遇到错误行时给出可定位的错误信息（行号、错误类型）。
    - 允许在部分行失败时采取策略（例如跳过错误图元、全局失败等，由 PA 约定）。

### TASK-7-GE-04 版本与向后兼容策略
- 职责：
  - 在每行或 META 中加入版本信息字段。
  - 设计简单的向后兼容机制：
    - 对未知字段忽略处理。
    - 对缺失字段使用默认值或记录警告。

## FE 系（frontend-architect）

### TASK-7-FE-01 编解码入口与 UI 挂钩
- 职责：
  - 在菜单或工具栏中提供：
    - 导出到文本（复制到剪贴板或下载文件）。
    - 从文本导入（弹窗输入多行文本）。
  - 通过 GraphicsMediator 调用内核提供的 `encodeScene` / `decodeScene` 接口。
- 输出：
  - 对接 UI 的操作流程与基本提示文案（成功/失败提醒）。

## RE 系（rendering-core-expert）

### TASK-7-RE-01 解码后渲染一致性支持
- 职责：
  - 确认当 Scene 通过解码恢复后：
    - 渲染引擎在接收到新 Scene 数据时能完整重绘，且结果与原始场景一致（在容差范围内）。
  - 若有必要，为 QA 提供辅助接口以获取当前渲染状态用于比对。

## QA 系（qa-automation-expert）

### TASK-7-QA-01 编解码单元测试
- 职责：
  - 对每类图元执行：
    - Model → encode → decode → Model，检查前后数据结构是否一致（或在可接受误差范围内）。
  - 测试错误行处理：
    - 构造格式错误或字段缺失的行，验证 decode 是否返回合理错误信息。

### TASK-7-QA-02 场景级一致性测试
- 职责：
  - 在典型场景下：
    - 将场景编码为文本 → 清空内存 → 解码恢复场景。
    - 比较恢复前后的 Scene 结构和渲染输出（结合渲染基准图）。

