# 需求 6：键盘快捷键系统（优雅设计 + 单元测试）—— 任务分发

目标：建立一个可扩展、可配置、可测试的快捷键系统，用于统一管理全局和上下文相关的键盘行为（如撤销/重做、工具切换、取消当前操作等），并区分 UI 快捷键与内核快捷键。

## PA 系（product-architect）

### TASK-6-PA-01 快捷键策略与优先级定义
- 职责：
  - 定义全局快捷键：
    - 撤销：Ctrl+Z。
    - 重做：Ctrl+Shift+Z 或 Ctrl+Y（选择其一）。
    - 取消当前操作：Esc。
  - 定义常用工具切换快捷键（建议）：
    - 选择工具：V。
    - 墙体绘制工具：W 或 L。
    - 门窗工具：D / 窗用另一个键。
    - 尺寸标注工具：M 或其他。
  - 定义上下文：
    - 编辑器聚焦时才启用快捷键；输入框聚焦时屏蔽部分快捷键（避免影响文本输入）。
- 输出：
  - 快捷键映射清单，标注是否可自定义、是否覆盖浏览器默认行为。

### TASK-6-PA-02 UI 快捷键与内核快捷键边界
- 职责：
  - 定义快捷键类型划分：
    - UI 快捷键：用于打开/关闭弹窗、切换侧边面板、触发非画布操作等。
    - 内核快捷键：用于操作画布与图元（绘制、选择、撤销、变换等）。
  - 明确冲突处理规则：
    - 同一组合键如同时被 UI 与内核使用时，由哪一侧优先。
  - 输出拆分表：列出已有/计划快捷键属于 UI 还是内核。
- 输出：
  - 更新快捷键规范章节，增加「UI vs 内核」维度划分。

## FE 系（frontend-architect）

### TASK-6-FE-01 ShortcutManager 设计与实现
- 职责：
  - 实现一个独立模块 `ShortcutManager`：
    - 负责注册/注销快捷键（键位 + 修饰键 + 上下文）。
    - 负责监听全局 keydown/keyup 事件并进行匹配。
    - 将匹配结果转换为逻辑 action（如 `ACTION.UNDO`、`ACTION.SWITCH_TOOL_SELECT`）。
  - 支持：
    - 多个模块注册自己的快捷键（内部做冲突检测或按优先级处理）。
    - 根据当前上下文（编辑器是否聚焦、是否在输入框内）动态启用/禁用。

### TASK-6-FE-02 快捷键类型与枚举设计
- 职责：
  - 定义逻辑快捷键枚举，用于表达「意图」而非物理按键，例如：
    - `ShortcutAction.UNDO`, `ShortcutAction.REDO`, `ShortcutAction.SWITCH_TOOL_SELECT` 等。
  - 为工具类设计专用快捷键枚举：
    - 例如 `ToolShortcutAction.Confirm`, `ToolShortcutAction.Cancel`, `ToolShortcutAction.ToggleSnap` 等。
  - 在 ShortcutManager 中：
    - 将物理按键映射为逻辑 ShortcutAction。
    - 再由中介者/内核将通用 ShortcutAction 转译为具体 ToolShortcutAction。

### TASK-6-FE-03 与 event-bus 集成
- 职责：
  - 将 ShortcutManager 识别出的逻辑 action 通过 event-bus 发布：
    - `COMMAND.UNDO` / `COMMAND.REDO`。
    - `UI.SWITCH_TOOL_*`（选择/墙体/门窗/标注等）。
    - `UI.CANCEL_OPERATION`（Esc）。
  - 避免在多个地方重复处理同一快捷键。

### TASK-6-FE-04 配置化与未来用户自定义预留
- 职责：
  - 使用数据结构描述快捷键映射：
    - 如：`{ action: 'UNDO', key: 'z', ctrl: true, shift: false }`。
  - 为未来「用户自定义快捷键」预留加载/保存接口（本阶段可仅实现内部默认配置）。

## GE 系（graphics-engineer）

### TASK-6-GE-01 动作接口定义
- 职责：
  - 为常用快捷键相关动作提供统一接口：
    - 撤销/重做：`undo()`, `redo()`（需求 4 实现）。
    - 工具切换：`setCurrentTool(toolId)`。
    - 取消当前操作：`cancelCurrentOperation()`（例如退出绘制模式）。
  - 保证这些接口可由 GraphicsMediator 安全调用。

### TASK-6-GE-02 与中介者的对接约定
- 职责：
  - 约定 GraphicsMediator 如何从 event-bus 获取逻辑 action，并映射到内核接口调用：
    - 例如：收到 `COMMAND.UNDO` → 调用 `kernel.undo()`。
    - 收到 `UI.SWITCH_TOOL_SELECT` → 调用 `kernel.setCurrentTool('select')`。

### TASK-6-GE-03 工具内快捷键解析与分发
- 职责：
  - 在 Tool 抽象类中增加快捷键处理接口：
    - 如 `handleShortcut(action: ToolShortcutAction): boolean`。
  - 内核在接收到与画布相关的快捷键信息时：
    - 将通用 ShortcutAction 转换为 ToolShortcutAction。
    - 交给当前激活工具链中的工具按顺序处理（可采用职责链模式）。
  - 确保：
    - 工具内部可根据自己的键位设计做细粒度分发，例如：Enter 确认绘制、Esc 取消、空格切换临时模式等。

## QA 系（qa-automation-expert）

### TASK-6-QA-01 ShortcutManager 单元测试
- 职责：
  - 针对 ShortcutManager：
    - 测试不同组合键匹配是否准确（包含 Ctrl/Shift/Alt 等）。
    - 测试在不同上下文（输入框聚焦/编辑器聚焦）下，快捷键触发情况是否符合预期。
    - 测试快捷键注册/注销后是否生效。

### TASK-6-QA-02 快捷键端到端行为测试
- 职责：
  - 使用 E2E 工具模拟：
    - Ctrl+Z / Ctrl+Shift+Z：验证对应撤销/重做行为是否发生。
    - 工具切换快捷键（V/W 等）：检查 UI 高亮的工具和当前内核工具是否一致。
    - Esc：在绘制模式中按下是否能取消当前操作、回到选择模式。
