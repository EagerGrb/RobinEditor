# 需求 2：右键画布平移 + 选中图元平移/旋转/缩放 —— 任务分发

目标：

1. 支持用户按住右键拖拽来平移画布（pan）。
2. 支持对选中图元进行平移、旋转、缩放操作，并通过控制柄（handles）实现精确交互。

假设：

- 右键拖拽空白区域：平移画布。
- 选中图元的变换：通过左键拖拽控制柄实现（更符合 Figma / CAD 心智）。

## PA 系（product-architect）

### TASK-2-PA-01 画布平移与变换交互规范
- 职责：
  - 明确：
    - 右键 + 拖拽空白区域 → 视口平移。
    - 中键拖拽是否作为平移的备选方式（可选）。
  - 明确变换方式：
    - 选中图元后显示包围盒和控制柄：
      - 四角用于等比缩放或自由缩放（需定义）。
      - 边中点用于单方向拉伸（可选）。
      - 外圈句柄或专门图标用于旋转。
  - 明确变换 pivot：
    - 默认：选中集的包围盒中心。
- 输出：
  - 更新交互规范文档中「视图操作」和「对象变换」章节。

## FE 系（frontend-architect）

### TASK-2-FE-01 右键拖拽识别与事件封装
- 职责：
  - 在 Canvas 容器中：
    - 识别 `mousedown` + `button === right` 且发生在空白区域时，进入「平移模式」。
    - 在 `mousemove` / `mouseup` 中计算拖拽 delta（屏幕坐标）。
  - 封装并发布以下事件：
    - `INPUT.VIEWPORT_PAN_START`（起始屏幕坐标）。
    - `INPUT.VIEWPORT_PAN_MOVE`（deltaX, deltaY）。
    - `INPUT.VIEWPORT_PAN_END`。
- 输出：
  - 一套供内核消费的标准化平移事件。

### TASK-2-FE-02 控制柄（handles）UI 叠加层
- 职责：
  - 当收到 `GRAPHICS.SELECTION_CHANGED` 事件时：
    - 获取当前选中集的包围盒（由内核提供）。
    - 在 UI 叠加层绘制：包围盒矩形 + 缩放手柄 + 旋转手柄。
  - 为每个手柄监听鼠标事件：
    - 左键按下 → 记录手柄类型与起点位置。
    - 鼠标移动 → 计算拖拽 delta 并发布变换事件。
    - 鼠标抬起 → 结束变换。
  - 封装并发布事件：
    - `INPUT.TRANSFORM_HANDLE_START`（handleType, 起点坐标）。
    - `INPUT.TRANSFORM_HANDLE_DRAG`（handleType, 当前坐标/Delta）。
    - `INPUT.TRANSFORM_HANDLE_END`。

## GE 系（graphics-engineer）

### TASK-2-GE-01 视口状态与平移实现
- 职责：
  - 在内核中维护统一视口状态结构：
    - `offsetX`, `offsetY`, `scale`（缩放比由需求 3 一并使用）。
  - 订阅 `INPUT.VIEWPORT_PAN_*` 事件：
    - 将屏幕坐标下的拖拽 delta 转换为视口偏移量调整。
    - 更新视口状态后，触发重绘请求，并发布 `VIEWPORT.PAN_CHANGED` 事件（携带最新 offset）。

### TASK-2-GE-02 选中集平移/缩放/旋转算法
- 职责：
  - 设计对一组图元的变换：
    - 平移：将选中图元的关键点按同一向量平移（在世界坐标中操作）。
    - 缩放：以包围盒中心为 pivot，对图元的点坐标进行缩放。
    - 旋转：以 pivot 为中心，对图元的点坐标进行旋转变换（使用矩阵或基本三角函数）。
  - 确保精度：
    - 使用双精度浮点计算，避免大尺度场景下误差积累明显。
    - 若有必要，对展示层进行适度格式化（不影响内存中精度）。
- 输入：
  - 当前选中集的 Model 集合。
  - 由 FE 封装的 `INPUT.TRANSFORM_HANDLE_*` 事件（提供 handle 类型和拖拽信息）。
- 输出：
  - 更新后的 Model 状态和对应的增量变更（供渲染引擎使用）。

### TASK-2-GE-03 控制柄到变换类型映射
- 职责：
  - 根据 handleType 与拖拽方向，判定变换的具体含义：
    - 四角手柄：等比缩放或自由缩放（依据 PA 定义）。
    - 边中点手柄：单方向拉伸（可选）。
    - 旋转手柄：根据拖拽弧度计算旋转角度。
  - 将 FE 的「屏幕空间拖拽」转换为世界空间的变换参数。

### TASK-2-GE-04 与 Command 系统的集成（平移/变换可撤销）
- 职责：
  - 在变换结束时（`INPUT.TRANSFORM_HANDLE_END`）：
    - 构造相应的 TransformShapesCommand（参考需求 4）。
    - 将本次变换作为可撤销操作记录到历史栈中。

## RE 系（rendering-core-expert）

### TASK-2-RE-01 视口偏移与缩放支持
- 职责：
  - 在渲染接口中支持基于视口状态进行变换：
    - 方式一：在渲染前对 DrawCommand 中的坐标进行视口转换。
    - 方式二：在 Canvas 上设置 transform（平移 + 缩放），然后再绘制图元。
  - 由内核或中介者将最新视口状态传递至渲染引擎。

### TASK-2-RE-02 控制柄与包围盒的渲染（如由渲染层负责）
- 职责：
  - 若决定由渲染层绘制选中包围盒与控制柄：
    - 定义专用 Primitive 类型或在 DrawCommand 中增加标记。
    - 实现可配置样式（颜色、大小、形状）。

## QA 系（qa-automation-expert）

### TASK-2-QA-01 视口平移精度测试
- 职责：
  - 编写单元测试：
    - 在多种缩放值下，应用相同屏幕拖拽 delta，检查视口 offset 变化是否符合预期。
  - E2E 测试：
    - 右键拖动画布后，检查图元间相对位置保持不变，仅视图出现平移。

### TASK-2-QA-02 选中集变换正确性与稳定性
- 职责：
  - 构造简单图元场景（1~3 个矩形/墙体/门窗）：
    - 通过控制柄进行平移、旋转、缩放操作。
    - 验证变更后的 Model 数据是否在容许误差内准确。
    - 连续多次变换后是否出现明显几何漂移或错位。

### TASK-2-QA-03 变换与撤销集成测试
- 职责：
  - 配合需求 4 的命令系统：
    - 完成一次变换后执行撤销，检查图元恢复到变换前状态。
    - 再次重做，确认变换被重新应用。

