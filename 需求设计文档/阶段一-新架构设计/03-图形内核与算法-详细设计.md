# 03-图形内核与算法-详细设计

## 1. 基础图元模块 (Basic Primitives)

### 1.1 职责
由内核负责实现的纯数学与几何表达，不含业务语义（区别于 Wall/Item）。渲染引擎仅负责绘制这些图元。
所有基础图元均继承自 `Primitive` 抽象基类。

### 1.2 图元体系 (Primitive System)

#### 1.2.1 抽象基类 (Primitive)
```typescript
abstract class Primitive {
  // 通用属性
  id: string;
  style: ShapeStyle | LineStyle;
  
  // 抽象方法
  abstract clone(): Primitive;
  abstract getBounds(): Box2;
  abstract transform(matrix: Mat3): void;
}
```

#### 1.2.2 基础线条 (Line Primitives)
这些图元代表不可再分的连续曲线。

*   **Line (线段)**
    *   `start: Vec2`, `end: Vec2`
*   **Arc (圆弧)**
    *   `center: Vec2`, `radius: number`, `startAngle: number`, `endAngle: number`, `clockwise: boolean`
*   **Bezier (贝塞尔曲线)**
    *   `p0: Vec2` (起点), `p1: Vec2` (控制点1), `p2: Vec2` (控制点2), `p3: Vec2` (终点)
    *   支持二次（p1=p2）或三次贝塞尔。

#### 1.2.3 复合图元 (Composite Primitives)

*   **Triangle (三角形)**
    *   `p0: Vec2`, `p1: Vec2`, `p2: Vec2`
    *   最基础的面图元。

*   **Polyline (多段线/复合路径)**
    *   **定义**: 由多个首尾相连的 `Primitive` 组成的**不带洞**的开放或闭合路径。
    *   **结构**: `segments: Primitive[]` (数组元素通常为 Line, Arc, Bezier)
    *   **特点**: 
        *   连续性：`segments[i].end` 必须等于 `segments[i+1].start`。
        *   支持混合线型（如直线接圆弧）。

*   **Polygon (带洞多边形)**
    *   **定义**: 由一个外轮廓和若干内轮廓（洞）组成的填充区域。
    *   **结构**:
        *   `exterior: Polyline` (外轮廓，**顺时针**方向)
        *   `holes: Polyline[]` (内洞，**逆时针**方向)
    *   **特点**: 支持彩色填充 (Fill) 和 描边 (Stroke)。

### 1.3 渲染接口
内核通过 `IRenderer` 接口调用渲染引擎，解耦具体实现（Canvas/WebGL）。
```typescript
interface IRenderer {
  drawPrimitive(primitive: Primitive): void;
  // 便捷方法
  drawLine(line: Line): void;
  drawPolyline(polyline: Polyline): void;
  drawPolygon(polygon: Polygon): void;
  drawText(text: string, pos: Vec2, style: TextStyle): void;
}
```

## 2. 模型视图层模块 (Model-View Layer)

### 2.1 职责
作为 Kernel Model (业务数据) 与 Render Engine (视觉呈现) 之间的桥梁。
负责将 Wall/Hole 等业务对象转换为 Basic Primitives。

### 2.2 视图生成器 (ViewGenerator)
*   **Input**: Scene Entity (e.g., Wall with thickness, height, holes).
*   **Process**: 
    1.  计算墙体几何轮廓（考虑厚度）。
    2.  扣除洞口区域（布尔运算）。
    3.  生成填充多边形和边框线段。
*   **Output**: List of DrawCommands (Primitives).

## 3. 算法模块 (Algorithm Module)

### 3.1 职责
提供通用的几何算法支持，供内核和其他模块调用。

### 3.2 核心算法库
*   **Geometry Math**: 向量运算、矩阵变换、距离计算。
*   **Boolean Operations**: 多边形并集、交集、差集 (Clipper / Earcut)。
*   **Triangulation**: 将多边形剖分为三角形（用于 WebGL 渲染）。
*   **Snap System**: 吸附点计算（端点、中点、垂足、网格点）。
*   **Path Finding**: 房间连通性分析（可选）。

### 3.3 接口定义
```typescript
interface GeometryLib {
  distance(p1: Point, p2: Point): number;
  isPointInPolygon(p: Point, poly: Point[]): boolean;
  intersectLineLine(l1: Segment, l2: Segment): Point | null;
  offsetPolygon(poly: Point[], distance: number): Point[];
}
```
