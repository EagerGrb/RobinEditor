# 01-UI框架与交互系统-详细设计

## 1. UI 框架 (Data-Driven UI Framework)

### 1.1 设计目标
实现 UI 的完全数据驱动，界面布局、组件渲染、属性绑定均由 JSON 配置或 State 定义，解耦 View 与 Logic。

### 1.2 核心架构
*   **Layout Engine**: 基于 Flex/Grid 的动态布局引擎，读取 `LayoutConfig` 渲染界面。
*   **Component Registry**: UI 组件注册表，映射 `componentKey` 到 React 组件。
*   **Data Binding**: 双向绑定机制，连接 `UI State` 与 `Kernel Model`。

### 1.3 接口定义
```typescript
interface UILayout {
  areas: {
    leftPanel: PanelConfig;
    rightPanel: PanelConfig;
    bottomPanel: PanelConfig;
    viewport: ViewportConfig;
  };
}

interface PanelConfig {
  visible: boolean;
  width?: number;
  height?: number;
  tabs: TabConfig[];
}

interface TabConfig {
  id: string;
  title: string;
  content: ComponentConfig; // 引用注册组件
}
```

## 2. 属性面板模块 (Property Panel Module)

### 2.1 职责
管理左（大纲/素材）、右（属性/设置）、底（日志/Timeline）三块面板的内容渲染与数据交互。

### 2.2 编解码机制 (Encoder/Decoder)
属性面板不直接操作内核对象，而是通过 `PropertyAdapter` 进行转换。
*   **Decode (Model -> UI)**: 选中图元时，Adapter 读取图元属性，转换为 `FormSchema`。
*   **Encode (UI -> Model)**: 表单变更时，Adapter 将 UI 值转换为内核命令，提交修改。

### 2.3 接口定义
```typescript
interface PropertyAdapter<T> {
  targetType: string; // e.g., 'Wall', 'Hole'
  decode(entity: T): FormSchema;
  encode(formData: any, entity: T): Command;
}

interface FormSchema {
  groups: {
    title: string;
    fields: FieldDef[];
  }[];
}

interface FieldDef {
  key: string;
  label: string;
  type: 'text' | 'number' | 'color' | 'select' | 'slider';
  value: any;
  options?: any[];
}
```

## 3. 对话框模块 (Dialog Module)

### 3.1 职责
作为内核与 UI 的中间件，处理非模态/模态弹窗、确认框、复杂参数配置器。

### 3.2 消息总线交互
内核不直接调用 UI API，而是发送 `DIALOG_REQUEST` 事件。
UI 层监听事件并渲染对应的 React 组件。

### 3.3 接口定义
```typescript
enum DialogType {
  ALERT = 'ALERT',
  CONFIRM = 'CONFIRM',
  PROMPT = 'PROMPT',
  CUSTOM = 'CUSTOM'
}

interface DialogRequest {
  id: string;
  type: DialogType;
  title: string;
  content?: string;
  component?: string; // Custom dialog component key
  props?: any;
  onConfirm?: (data: any) => void;
  onCancel?: () => void;
}
```

## 4. 快捷键管理模块 (Shortcut Manager)

### 4.1 职责
*   提供可配置的快捷键映射表 (KeyMap)。
*   处理键盘事件，解决冲突。
*   分发 Command 到内核。

### 4.2 数据结构
```typescript
interface ShortcutConfig {
  context: string; // e.g., 'GLOBAL', 'DRAWING_MODE'
  key: string;     // e.g., 'Ctrl+Z', 'Delete'
  command: string; // e.g., 'UNDO', 'DELETE_SELECTION'
  args?: any;
}

interface ShortcutRegistry {
  [context: string]: ShortcutConfig[];
}
```
