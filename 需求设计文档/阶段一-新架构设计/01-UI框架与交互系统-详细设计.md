# 01-UI框架与交互系统-详细设计

适用范围：基于 Canvas 的 PCB 2D 编辑器（板级视图）的 UI 与交互系统。

## 1. UI 框架 (Data-Driven UI Framework)

### 1.1 设计目标
实现 UI 的完全数据驱动，界面布局、组件渲染、属性绑定均由 JSON 配置或 State 定义，解耦 View 与 Logic。

### 1.2 核心架构
*   **Layout Engine**: 基于 Flex/Grid 的动态布局引擎，读取 `LayoutConfig` 渲染界面。
*   **Component Registry**: UI 组件注册表，映射 `componentKey` 到 React 组件。
*   **Data Binding**: 双向绑定机制，连接 `UI State` 与 `Kernel Model`。

### 1.3 接口定义
```typescript
interface UILayout {
  areas: {
    leftPanel: PanelConfig;
    rightPanel: PanelConfig;
    bottomPanel: PanelConfig;
    viewport: ViewportConfig;
  };
}

interface PanelConfig {
  visible: boolean;
  width?: number;
  height?: number;
  tabs: TabConfig[];
}

interface TabConfig {
  id: string;
  title: string;
  content: ComponentConfig; // 引用注册组件
}
```

## 2. 属性面板模块 (Property Panel Module)

### 2.1 职责
管理左（Footprint/Net 列表、层面板）、右（实体属性/板设置）、底（日志/DRC 提示）三块面板的内容渲染与数据交互。

### 2.2 编解码机制 (Encoder/Decoder)
属性面板不直接操作内核对象，而是通过 `PropertyAdapter` 进行转换。
*   **Decode (Model -> UI)**: 选中图元时，Adapter 读取图元属性，转换为 `FormSchema`。
*   **Encode (UI -> Model)**: 表单变更时，Adapter 将 UI 值转换为内核命令，提交修改。

### 2.3 接口定义
```typescript
interface PropertyAdapter<T> {
  targetType: string; // e.g., 'Footprint', 'Pad', 'Track', 'Via', 'BoardOutline'
  decode(entity: T): FormSchema;
  encode(formData: any, entity: T): Command;
}

interface FormSchema {
  groups: {
    title: string;
    fields: FieldDef[];
  }[];
}

interface FieldDef {
  key: string;
  label: string;
  type: 'text' | 'number' | 'color' | 'select' | 'slider';
  value: any;
  options?: any[];
}
```

## 3. 对话框模块 (Dialog Module)

### 3.1 职责
作为内核与 UI 的中间件，处理非模态/模态弹窗、确认框、复杂参数配置器。

### 3.2 消息总线交互
内核不直接调用 UI API，而是发送 `DIALOG_REQUEST` 事件。
UI 层监听事件并渲染对应的 React 组件。

### 3.3 接口定义
```typescript
enum DialogType {
  ALERT = 'ALERT',
  CONFIRM = 'CONFIRM',
  PROMPT = 'PROMPT',
  CUSTOM = 'CUSTOM'
}

interface DialogRequest {
  id: string;
  type: DialogType;
  title: string;
  content?: string;
  component?: string; // Custom dialog component key
  props?: any;
  onConfirm?: (data: any) => void;
  onCancel?: () => void;
}
```

## 4. 快捷键管理模块 (Shortcut Manager)

### 4.1 职责
*   提供可配置的快捷键映射表 (KeyMap)，覆盖 PCB 视图与编辑工具（选择、放 Footprint、走线、放 Via 等）。
*   处理键盘事件，解决冲突，并区分 UI 快捷键与内核命令级快捷键。
*   分发 Command 到内核，与历史记录系统协同工作。

### 4.2 数据结构
```typescript
interface ShortcutConfig {
  context: string; // e.g., 'GLOBAL', 'DRAWING_MODE'
  key: string;     // e.g., 'Ctrl+Z', 'Delete'
  command: string; // e.g., 'UNDO', 'DELETE_SELECTION'
  args?: any;
}

interface ShortcutRegistry {
  [context: string]: ShortcutConfig[];
}

## 5. 角色与责任分工（智能体）

- 前端架构（frontend-architect）
  - 负责本文件中 UI 框架、属性面板、对话框系统、快捷键管理模块的整体设计与实现；
  - 与图形内核协作，确保 PCB 工具和实体（Footprint/Pad/Track/Via/BoardOutline）的状态在 UI 中正确呈现与可操作。
- 产品架构师（product-architect）
  - 定义 PCB 编辑器关键交互流程（放置 Footprint、走线、放 Via、修改属性等）以及对应的 UI 行为规范；
  - 审阅并约束布局与交互是否符合目标用户（PCB 工程师 / Maker）的认知习惯。
- 图形开发专家（graphics-engineer）
  - 提供与 UI 对接的内核接口，包括选择系统、工具状态、命令执行入口等；
  - 协助定义快捷键与内核命令（Command）的映射关系。
- 渲染引擎专家（rendering-core-expert）
  - 支持 UI 对渲染层的需求（如视口控制、图层可见性切换、高亮/选中效果），提供必要的渲染 API。
- 测试专家（qa-automation-expert）
  - 基于本文件设计 UI 层的交互自动化测试用例（快捷键、右键菜单、属性修改流程等）；
  - 覆盖典型 PCB 操作路径的可用性与回归测试。
```
