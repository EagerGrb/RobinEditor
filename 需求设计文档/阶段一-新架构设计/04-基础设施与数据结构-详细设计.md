# 04-基础设施与数据结构-详细设计

适用范围：支撑 PCB 图形编辑器的大规模实体管理、事件通信与基础几何表示的公共基础设施。

## 1. 核心数据结构库 (Graphics Kernel)

### 1.1 设计目标
为图形编辑器提供高性能、类型安全的基础数据容器，特别是针对大量图元的管理与渲染排序。

### 1.2 模块：`@robin/structure`

#### 1.2.1 PriorityQueue (优先队列)
*   **用途**: A* 寻路、渲染层级排序、事件调度。
*   **接口**:
    ```typescript
    interface IPriorityQueue<T> {
      push(item: T): void;
      pop(): T | undefined;
      peek(): T | undefined;
      size(): number;
      isEmpty(): boolean;
    }
    ```
*   **实现**: 基于二叉堆 (Binary Heap) 实现，支持自定义比较器 `Comparator<T>`.

#### 1.2.2 LinkedHashMap (链式哈希表)
*   **用途**: 维护图元插入顺序（如 Layer 中的图元列表），同时支持 O(1) 的 ID 查找。
*   **接口**:
    ```typescript
    interface ILinkedHashMap<K, V> {
      set(key: K, value: V): void;
      get(key: K): V | undefined;
      delete(key: K): boolean;
      has(key: K): boolean;
      clear(): void;
      // 迭代器支持
      forEach(callback: (value: V, key: K) => void): void;
      keys(): IterableIterator<K>;
      values(): IterableIterator<V>;
    }
    ```
*   **实现**: 使用 Map + 双向链表 (Doubly Linked List) 维护顺序。

#### 1.2.3 QuadTree (四叉树) - 占位，将在算法模块详细设计
*   **用途**: 空间查询、视口剔除、鼠标拾取。

---

## 2. 前端工具库 (Frontend Utils)

### 2.1 设计目标
提供纯函数式的通用工具，避免对 lodash 等大型库的过度依赖，确保 Tree Shaking 友好。

### 2.2 模块：`@robin/utils`

#### 2.2.1 函数工具
*   `debounce(fn, wait, options)`: 防抖，用于窗口 Resize、输入框搜索。
*   `throttle(fn, wait, options)`: 节流，用于鼠标移动、滚轮缩放事件。

#### 2.2.2 对象工具
*   `deepClone<T>(obj: T): T`: 深拷贝，支持处理 Date, RegExp, Map, Set，解决循环引用。
*   `merge<T>(target: T, ...sources: Partial<T>[]): T`: 深度合并配置项。

#### 2.2.3 随机与 ID
*   `uuid()`: 生成 UUID v4。
*   `nanoid(size?)`: 生成短 ID。

---

## 3. 全链路通信总线 (Event Bus)

### 3.1 设计目标
构建跨环境（Main Thread <-> Web Worker）的统一通信机制，解耦 UI、内核与渲染线程。

### 3.2 模块：`@robin/bus`

### 3.3 接口定义

#### 3.3.1 基础 Pub/Sub
```typescript
type EventHandler<T = any> = (payload: T) => void;

interface IEventBus {
  // 发布事件
  publish<T>(topic: string, payload: T): void;
  
  // 订阅事件，返回取消订阅函数
  subscribe<T>(topic: string, handler: EventHandler<T>): () => void;
  
  // 销毁总线
  destroy(): void;
}
```

#### 3.3.2 RPC (Remote Procedure Call)
用于跨模块/跨线程的异步调用，支持 Promise。

```typescript
interface IRpcService {
  // 注册服务方法
  registerService(serviceName: string, methods: Record<string, Function>): void;
  
  // 调用远程方法
  call<T = any>(serviceName: string, methodName: string, args: any[]): Promise<T>;
}
```

### 3.4 实现策略
*   **Main Bus**: 在主线程运行，负责 UI 组件间通信。
*   **Worker Bridge**: 通过 `postMessage` 桥接，将 RPC 调用序列化后发送给 Worker，Worker 处理后回传 Promise Resolve/Reject。

---

## 4. 图形内核基础定义 (Primitives & Polygons)

### 4.1 多边形数据格式 (Polygon)
采用更严格的几何定义，支持混合曲线边界和带洞结构。

```typescript
/**
 * 复合路径 (Polyline)
 * 由一系列连续的图元组成 (Line | Arc | Bezier)
 */
interface Polyline {
  segments: Primitive[]; // 必须首尾相连
  closed: boolean;
}

/**
 * 带洞多边形 (Polygon)
 * 渲染规则：非零环绕 (Non-Zero) 或 奇偶规则 (Even-Odd)
 */
interface Polygon {
  exterior: Polyline; // 外轮廓 (Clockwise)
  holes: Polyline[];  // 内洞 (Counter-Clockwise)
}
```

### 4.2 Canvas 2D 基础绘图接口 (IRenderer2D)

内核不依赖具体的 Canvas Context API，而是依赖抽象接口。

```typescript
interface IRenderer2D {
  // 状态控制
  save(): void;
  restore(): void;
  scale(x: number, y: number): void;
  translate(x: number, y: number): void;
  
  // 基础绘制
  drawLine(line: Line): void;
  drawArc(arc: Arc): void;
  drawBezier(bezier: Bezier): void;
  
  // 复合绘制
  // 实现时需遍历 segments，调用 context.lineTo / arcTo / bezierCurveTo
  drawPolyline(polyline: Polyline): void;
  
  // 多边形绘制
  // 实现时需:
  // 1. context.beginPath()
  // 2. 绘制 exterior (顺时针)
  // 3. 绘制 holes (逆时针) -> 利用 Canvas 的非零环绕规则自动挖洞
  // 4. context.fill() / context.stroke()
  drawPolygon(polygon: Polygon): void;
  
  // 文本
  drawText(text: string, position: Vec2, style: TextStyle): void;
  
  // 清除
  clear(rect?: Rect): void;
}

## 5. 角色与责任分工（智能体）

- 图形开发专家（graphics-engineer）
  - 负责 `@robin/structure` 与 `@robin/bus` 等内核侧基础设施的设计与实现；
  - 定义 QuadTree、LinkedHashMap 等数据结构在 PCB 实体管理与命中/选择中的使用方式。
- 前端架构（frontend-architect）
  - 负责前端工具库 `@robin/utils` 的使用规范与扩展，实现 UI 层对 Event Bus 的封装；
  - 结合应用状态管理方案，设计主线程内的事件通路与跨线程 Bridge 使用方式。
- 渲染引擎专家（rendering-core-expert）
  - 负责 IRenderer2D 的具体实现，以及与多层 PCB 渲染相关的性能优化策略；
  - 与 graphics-engineer 协同确定多边形、Polyline 等数据结构在渲染管线中的约束。
- 测试专家（qa-automation-expert）
  - 针对 PriorityQueue、LinkedHashMap、QuadTree、Event Bus、IRenderer2D 等核心基础设施编写稳定性与性能测试；
  - 建立与 PCB 业务无关但可复用的基础设施测试用例库。

```
