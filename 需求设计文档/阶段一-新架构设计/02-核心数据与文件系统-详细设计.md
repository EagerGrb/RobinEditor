# 02-核心数据与文件系统-详细设计

适用范围：PCB 2D 编辑器中的 PcbDocument/Board/LayerStack/Net 等核心数据与文件系统。

## 1. 格式文件模块 (File Format Module)

### 1.1 职责
定义 RobinEditor 在 PCB 场景下的原生文件格式 (`.rbeditor`)，负责 PcbDocument/Board/LayerStack/Footprint/Track/Via/Net 等数据的完整序列化与反序列化。

### 1.2 格式规范 (JSON Schema)
文件包含三个主要部分：
1.  **Header**: 版本号、元数据、缩略图 (Base64)。
2.  **Resources**: 外部资源引用（封装库、图标资源等）列表。
3.  **Content**: PCB 文档数据（Board、LayerStack、Nets、Footprints、Tracks、Vias 等）。

### 1.3 接口定义
```typescript
interface RBFile {
  header: {
    version: string;
    appName: string;
    createdAt: number;
    updatedAt: number;
    thumbnail?: string;
  };
  settings: {
    unit: 'mm' | 'mil';
    origin: { x: number, y: number };
  };
  resources: ResourceDef[];
  content: SceneData;
}

interface FileCodec {
  encode(scene: Scene): Promise<RBFile>;
  decode(file: RBFile): Promise<Scene>;
}
```

## 2. 导入导出模块 (Import/Export Module)

### 2.1 职责
实现不同格式之间的转换器 (Converter)。

### 2.2 支持格式
*   **Import**: 简化网表 (.json/.net 等)、.dxf（板框/机械图层）、调试用行文本格式。
*   **Export**: .json（PcbDocument 快照）、.dxf（板框）、调试用行文本格式（单行实体编码）。

### 2.3 架构
采用策略模式：`ImporterStrategy` 和 `ExporterStrategy`。
```typescript
interface IImporter {
  test(fileExtension: string): boolean;
  import(file: File): Promise<Scene>;
}

interface IExporter {
  export(scene: Scene, options: any): Promise<Blob>;
}
```

## 3. 设计规则模块 (Design Rule Module)

### 3.1 职责
定义 PCB 设计约束（DRC），实时或按需校验设计合法性，生成错误报告。

### 3.2 规则定义
*   **Hard Rules** (强制约束): 无法通过操作违反（如：线宽不得小于最小宽度；过孔/焊盘间距不得小于规则；走线不得越出板框）。
*   **Soft Rules** (警告约束): 允许操作，但标记错误（如：某些 Net 没有连接完成、走线过于曲折、线长超出推荐值）。

### 3.3 数据结构
```typescript
interface Rule {
  id: string;
  level: 'ERROR' | 'WARNING';
  check(document: PcbDocument): RuleViolation[];
}

interface RuleViolation {
  ruleId: string;
  entityIds: string[];
  message: string;
  position?: { x: number, y: number };
}
```

## 4. 历史记录模块 (History Module)

### 4.1 职责
实现针对 PCB 操作的撤销/重做功能（放置/删除 Footprint、布线、放 Via、修改属性等）。

### 4.2 实现方案
*   **Command Pattern**: 所有对 Model 的修改必须封装为 Command (execute/undo)。
*   **Transaction**: 支持多条命令合并为一个历史步骤（如：拖拽过程中的连续 update）。

### 4.3 接口定义
```typescript
interface Command {
  name: string;
  execute(): void;
  undo(): void;
}

interface HistoryManager {
  push(cmd: Command): void;
  undo(): void;
  redo(): void;
  beginTransaction(): void;
  endTransaction(): void;
}
```

## 5. 核心结构缓存模块 (Core Cache Module)

### 5.1 职责
为了提升性能，对核心数据结构进行缓存，避免每帧重复计算。

### 5.2 缓存内容
*   **Spatial Index (空间索引)**: QuadTree / R-Tree，加速 Footprint/Pad/Track/Via 等对象的拾取与框选。
*   **Render List (渲染列表)**: 缓存 ViewGenerator 生成的 DrawCommands，仅在脏标记 (Dirty) 时更新。
*   **Computed Geometry**: 如板框多边形、覆铜区域轮廓、阻焊开窗轮廓等几何结果。

### 5.3 接口定义
```typescript
interface CacheManager {
  spatialIndex: SpatialIndex;
  renderCache: Map<string, DrawCommand[]>;
  
  invalidate(entityId: string): void;
  query(rect: Rect): string[]; // Returns entity IDs
}

## 6. 角色与责任分工（智能体）

- 产品架构师（product-architect）
  - 定义 PCB 文档的数据边界与演进方向（PcbDocument/Board/LayerStack/Net 等）；
  - 与图形开发专家协作定义 DRC 规则类别与严重级别，并确保与业务目标一致。
- 图形开发专家（graphics-engineer）
  - 负责 `.rbeditor` PCB 结构的具体 Schema 设计与 FileCodec 的实现；
  - 实现导入导出策略（Importer/Exporter），负责 PcbDocument 在内存中的模型结构；
  - 实现设计规则模块、历史记录模块与核心结构缓存。
- 前端架构（frontend-architect）
  - 对接文件打开/保存、导入/导出、DRC 报告等 UI 流程；
  - 确保文件和规则相关状态在 UI 层可视化、可操作。
- 测试专家（qa-automation-expert）
  - 设计 PcbDocument 编解码的回环测试、导入导出的一致性测试；
  - 针对 DRC 规则、历史记录栈、空间索引和缓存失效策略设计自动化测试用例。

```
