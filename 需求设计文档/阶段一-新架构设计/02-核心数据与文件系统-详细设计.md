# 02-核心数据与文件系统-详细设计

## 1. 格式文件模块 (File Format Module)

### 1.1 职责
定义 RobinEditor 的原生文件格式 (`.rbeditor`)，负责 Scene 数据的完整序列化与反序列化。

### 1.2 格式规范 (JSON Schema)
文件包含三个主要部分：
1.  **Header**: 版本号、元数据、缩略图 (Base64)。
2.  **Resources**: 外部资源引用（纹理、模型）列表。
3.  **Content**: 完整的 Scene Graph 数据（Layer -> Entity）。

### 1.3 接口定义
```typescript
interface RBFile {
  header: {
    version: string;
    appName: string;
    createdAt: number;
    updatedAt: number;
    thumbnail?: string;
  };
  settings: {
    unit: 'mm' | 'cm' | 'm';
    origin: { x: number, y: number };
  };
  resources: ResourceDef[];
  content: SceneData;
}

interface FileCodec {
  encode(scene: Scene): Promise<RBFile>;
  decode(file: RBFile): Promise<Scene>;
}
```

## 2. 导入导出模块 (Import/Export Module)

### 2.1 职责
实现不同格式之间的转换器 (Converter)。

### 2.2 支持格式
*   **Import**: .json (Legacy), .dxf (CAD), .png/jpg (背景图)。
*   **Export**: .json, .dxf, .gltf/glb (3D Model), .png (Screenshot)。

### 2.3 架构
采用策略模式：`ImporterStrategy` 和 `ExporterStrategy`。
```typescript
interface IImporter {
  test(fileExtension: string): boolean;
  import(file: File): Promise<Scene>;
}

interface IExporter {
  export(scene: Scene, options: any): Promise<Blob>;
}
```

## 3. 设计规则模块 (Design Rule Module)

### 3.1 职责
定义设计约束，实时或按需校验设计合法性，生成错误报告。

### 3.2 规则定义
*   **Hard Rules** (强制约束): 无法通过操作违反（如：墙体不能重叠，由内核拦截）。
*   **Soft Rules** (警告约束): 允许操作，但标记错误（如：门洞离墙角过近）。

### 3.3 数据结构
```typescript
interface Rule {
  id: string;
  level: 'ERROR' | 'WARNING';
  check(scene: Scene): RuleViolation[];
}

interface RuleViolation {
  ruleId: string;
  entityIds: string[];
  message: string;
  position?: { x: number, y: number };
}
```

## 4. 历史记录模块 (History Module)

### 4.1 职责
实现无限层级（或限制步数）的撤销/重做功能。

### 4.2 实现方案
*   **Command Pattern**: 所有对 Model 的修改必须封装为 Command (execute/undo)。
*   **Transaction**: 支持多条命令合并为一个历史步骤（如：拖拽过程中的连续 update）。

### 4.3 接口定义
```typescript
interface Command {
  name: string;
  execute(): void;
  undo(): void;
}

interface HistoryManager {
  push(cmd: Command): void;
  undo(): void;
  redo(): void;
  beginTransaction(): void;
  endTransaction(): void;
}
```

## 5. 核心结构缓存模块 (Core Cache Module)

### 5.1 职责
为了提升性能，对核心数据结构进行缓存，避免每帧重复计算。

### 5.2 缓存内容
*   **Spatial Index (空间索引)**: QuadTree / R-Tree，加速拾取 (Pick) 和框选。
*   **Render List (渲染列表)**: 缓存 ViewGenerator 生成的 DrawCommands，仅在脏标记 (Dirty) 时更新。
*   **Computed Geometry**: 如墙体生成的 Polygon，房间推导结果。

### 5.3 接口定义
```typescript
interface CacheManager {
  spatialIndex: SpatialIndex;
  renderCache: Map<string, DrawCommand[]>;
  
  invalidate(entityId: string): void;
  query(rect: Rect): string[]; // Returns entity IDs
}
```
