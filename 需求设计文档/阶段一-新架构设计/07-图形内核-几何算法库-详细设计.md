# 07-图形内核-几何算法库-详细设计

适用范围：服务于 PCB 图形编辑器的几何算法库，支撑 DRC、命中/吸附、视图渲染等核心计算。

## 1. 设计目标
构建一个独立、高性能、无副作用的几何算法库，支撑编辑器的核心计算需求（相交检测、距离计算、布尔运算）。
该库应作为 `packages/graphics-kernel/src/algorithm` 模块存在。

## 2. 基础数学结构 (Math Structures)

### 2.1 向量与矩阵
虽然可以使用 `gl-matrix` 等库，但为了类型安全和 API 统一，建议封装一层。

```typescript
// Vector2
export interface Vec2 { x: number; y: number; }
export const Vec2 = {
  add: (a: Vec2, b: Vec2) => Vec2,
  sub: (a: Vec2, b: Vec2) => Vec2,
  dot: (a: Vec2, b: Vec2) => number,
  cross: (a: Vec2, b: Vec2) => number, // 2D Cross Product (Scalar)
  len: (v: Vec2) => number,
  dist: (a: Vec2, b: Vec2) => number,
  normalize: (v: Vec2) => Vec2,
  rotate: (v: Vec2, angle: number) => Vec2,
};

// Matrix3 (2D Transform: 3x3 Matrix)
// 用于 Viewport 变换和局部坐标变换
export type Mat3 = [number, number, number, number, number, number, number, number, number];
```

### 2.2 包围盒 (AABB)
```typescript
export interface Box2 { min: Vec2; max: Vec2; }
export const Box2 = {
  create: (points?: Vec2[]) => Box2,
  expand: (box: Box2, p: Vec2) => Box2,
  intersects: (a: Box2, b: Box2) => boolean,
  contains: (box: Box2, p: Vec2) => boolean,
};
```

---

## 3. 核心算法 (Core Algorithms)

### 3.1 距离计算 (Distance)
用于鼠标拾取 (Picking) 和吸附 (Snapping)。

*   `pointToLineSegment(p: Vec2, a: Vec2, b: Vec2): { dist: number, closest: Vec2, t: number }`
    *   计算点 `p` 到线段 `ab` 的最短距离。
    *   返回最近点 `closest` 和参数 `t` (0~1)。
*   `pointToPolyline(p: Vec2, points: Vec2[]): { dist: number, segmentIndex: number, closest: Vec2 }`

### 3.2 相交检测 (Intersection)
用于设计规则校验、剪裁、自动打断墙体。

*   `intersectLineLine(a1, a2, b1, b2): Vec2 | null`
    *   检测两条线段是否相交。
*   `intersectCircleLine(c: Vec2, r: number, a: Vec2, b: Vec2): Vec2[]`
    *   圆与线段交点。
*   `isPointInPolygon(p: Vec2, polygon: Vec2[]): boolean`
    *   射线法 (Ray Casting) 实现。

### 3.3 多边形布尔运算 (Boolean Operations)
用于墙体融合、房间生成、复杂轮廓计算。
**选型**: 建议引入 `clipper-lib` (Clipper2) 或 `earcut` 的 WASM 版本以提升性能，但在 Stage 1 可使用纯 JS 版本的 `polygon-clipping` 或 `paper.js` 的子集。

```typescript
export const BooleanOps = {
  union: (polys: Polygon[]) => Polygon[],
  intersect: (polyA: Polygon, polyB: Polygon) => Polygon[],
  diff: (subject: Polygon, clip: Polygon) => Polygon[],
};
```

---

## 4. 空间索引 (Spatial Indexing)

### 4.1 QuadTree (四叉树)
用于加速大规模场景下的查询（如：框选 10000 个图元）。

#### 4.1.1 接口
```typescript
export class QuadTree<T> {
  constructor(bounds: Box2, capacity: number = 4, maxDepth: number = 8);
  
  insert(item: T, box: Box2): void;
  remove(item: T): void; // 难点：需要维护 item -> nodes 的映射
  
  queryRange(range: Box2): T[];
  queryPoint(p: Vec2): T[];
  
  clear(): void;
}
```

#### 4.1.2 实现细节
*   **节点结构**: 每个节点包含 `bounds`, `children[4]`, `items[]`。
*   **动态调整**: 当节点 item 数量超过 `capacity` 且深度未达 `maxDepth` 时，分裂 (Split)。
*   **跨越处理**: 如果一个物体跨越了分割线，可以存储在父节点，或者存储在多个子节点（Reference）。建议存储在**完全包含它的最小父节点**中，或者使用 Loose QuadTree。

---

## 5. 几何生成 (Geometry Generation)

### 5.1 偏移/扩边 (Offset/Buffer)
用于生成走线外形、板框膨胀/收缩、覆铜膨胀等几何结果。
*   `offsetPolyline(points: Vec2[], distance: number, joinType: 'miter'|'round'|'bevel'): Vec2[]`
*   需处理自交、锐角过长 (Miter Limit) 问题。

### 5.2 三角剖分 (Triangulation)
用于将带洞多边形转换为 WebGL 可渲染的三角形列表。
*   推荐使用 `earcut` 库（极快、鲁棒）。
*   输入: `[vertices, holeIndices, dim]`。
*   输出: `[index1, index2, index3, ...]`。

## 6. 角色与责任分工（智能体）

- 图形开发专家（graphics-engineer）
  - 负责几何算法库整体架构与关键算法（相交、距离、布尔、偏移、三角剖分等）的实现；
  - 结合 PCB 业务，确定算法在 DRC、命中/吸附、视图生成中的使用方式与精度要求。
- 渲染引擎专家（rendering-core-expert）
  - 基于渲染管线需求，对三角剖分、布尔运算结果提出约束与优化建议；
  - 参与评估算法在大规模 PCB 场景下的性能，并提出加速方案。
- 测试专家（qa-automation-expert）
  - 设计几何算法的单元与基准测试，包括极端几何（高密度走线、细小间距等）；
  - 确保几何算法在不同平台与精度设置下保持稳定和一致。
